# MIK32 Библиотека обработки исключений
*Для отладки*

\[RU/[EN](./README.md)]

---
## Системные требования
### Пакеты
- `mik32_transaction`
- `mik32_stdio`

---
## Предисловие
Исключения - это ситуации, в которых процессор не знает, что ему делать. Исключения могут быть вызваны попыткой чтения некорректной инструкции, попыткой чтения или записи из/в запрещенную для этого область памяти, ошибкой выравнивания и т.д. В микроконтроллере MIK32, содержащем ядро SCR1, при вызове исключений и прерываний процессор переходит по адресу `MTVEC`, где расположена подпрограмма обработки, `trap_handler`.

Данная библиотека содержит быструю подпрограмму обработки `trap_handler`, которая определяет, что было источником перехода на вектор `MTVEC`, прерывание или исключение. В случае прерывания управление немедленно передается пользователю. В случае исключения управление передается weak-функции `exception_handler`. Эта функция может быть переопределена пользователем. По-умолчанию она печатает в стандартный вывод информацию о том, что за исключение произошло, а также некоторую сопутствующую информацию.

---
## Типы данных: перечисления
#### `mik32_exception_test_t`
- `EXCEPTION_ILLEGAL_INSTRUCTION = 2` - попытка исполнения некорректной инструкции;
- `EXCEPTION_LOAD_ADDRESS_MISSALIGNED = 4` - ошибка выравнивания (alignment) при чтении;
- `EXCEPTION_STORE_ADDRESS_MISALIGNED = 6` - ошибка выравнивания (alignment) при записи;
- `EXCEPTION_ECALL_FROM_M_MODE = 11` - попытка исполнения инструкции `ECALL`.

---
## Методы
#### `void exception_handler(void)`
Обработчик исключений, weak-функция. По-умолчанию печатает в стандартный вывод информацию об исключении.
#### `mik32_exception_decoder(uint32_t mcause, uint32_t pc, uint32_t instruction)`
Выводит информацию о причинах исключения.
- `mcause` - содержимое регистра `MCAUSE` ядра;
- `pc` - содержимое регистра-счетчика команд `PC` (`x31`) при вызове исключения;
- `instruction` - опкод инструкции, вызвавшей исключение.
#### `void mik32_exception_caller(`[`mik32_exception_test_t`](#mik32_exception_test_t)`)`
Подпрограмма для принудительного вызова исключения (для тестов).
